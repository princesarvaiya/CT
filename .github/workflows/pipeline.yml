name: Deploy based on env
on:
    push: 
     branches: 
        - main

jobs: 
  test:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
     - uses: actions/checkout@v3
     
     - name: giving permissions and running
       #running
       run: |
        chmod +x github.sh
        bash -x github.sh
       shell: bash
  
  login:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    outputs:
      token: ${{ steps.ecr.outputs.token }}
    steps:
      -
        name: Get token to login to Amazon ECR
        uses: PhutureCorp/ecr-login-token@v0.8.0
        with:
          registry: <aws-account-number>.dkr.ecr.<region>.amazonaws.com
          username: ${{ secrets.AWS_ACCESS_KEY_ID }}
          password: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  build:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: login
    container:
      image: <aws-account-number>.dkr.ecr.<region>.amazonaws.com/<image>:<version>
      credentials:
        username: AWS
        password: ${{ needs.login.outputs.token }}
    steps:
    
    - uses: actions/checkout@v3
    - name: giving permissions and running
      run: |
        chmod +x github.sh
        bash -x github.sh
      shell: bash
      
      
