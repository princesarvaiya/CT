name: Deploy based on env
on:
    push: 
     branches: 
        - main
permissions:
   id-token: write
   contents: read 

jobs: 
     
  build:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      id-token: write
      contents: read
    steps:
     - uses: actions/checkout@v3
     - name: Get branch name
       id: branch_name
       run: echo "::set-output name=branch_name::${{ github.ref }}"
       
     - name: Check folder name
       run: |
         FOLDER_NAME=$(git diff-tree --no-commit-id --name-only -r $GITHUB_SHA | cut -d'/' -f1 | sort | uniq)
         echo "The folder name is $FOLDER_NAME"
            
       
     - name: Configure AWS credentials
       uses: aws-actions/configure-aws-credentials@v1 # More information on this action can be found below in the 'AWS Credentials' section
       with:
          role-to-assume: arn:aws:iam::085395249379:role/sreekanth-role-delete-me
          aws-region: us-east-1
          
     - name: Get ECR Login
       run: aws ecr get-login-password --region us-east-1 | docker login --pulical AWS --password-stdin 085395249379.dkr.ecr.us-east-1.amazonaws.com     
          
     - name: ecr image checking
       uses: aws-actions/configure-aws-credentials@v1 # More information on this action can be found below in the 'AWS Credentials' section
       with:
          role-to-assume: arn:aws:iam::085395249379:role/sreekanth-role-delete-me
          aws-region: us-east-1
       env:
         ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
         ECR_REPOSITORY: sample-repo
         IMAGE_TAG: ${{ github.sha }}
     - run: |
        docker build -t first .
        docker tag first:latest 085395249379.dkr.ecr.us-east-1.amazonaws.com/$ECR_REPOSITORY:$IMAGE_TAG
        docker push 085395249379.dkr.ecr.us-east-1.amazonaws.com/$ECR_REPOSITORY:$IMAGE_TAG
     
                 
     - name: login to amazon ECR
       id: login-ecr
       uses: aws-actions/amazon-ecr-login@v1
       
     
     - name: updating helm
       uses: bitovi/github-actions-deploy-eks-helm@v1.1.0
       
     - name: helm
       run: |
         export AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
         export AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
         export AWS_SESSION_TOKEN="IQoJb3JpZ2luX2VjEEYaCXVzLXdlc3QtMiJHMEUCIQD0XPL53FT+QLuOBUExJTENmmrCDTsp9QRQ79SLlh/LQQIgL1mOGPcFKYCcjmmfsLOlIe8uSYaYEAUPEfY/I6PLe1oq/AIIn///////////ARABGgwwODUzOTUyNDkzNzkiDIDPrP0q2ld/QvOtZyrQAqbFspX9OzAa9/VWFPMHjXEg5h1uzP1EjG62nuTo1C2cbDASPrB+JX9mh1TNYuzoUl/0BHsxas263tfIxQlxel4Rde6iB6XSpVcr+LxktfrQZycNbYs1t8KIEXuWXO7QqqeG4K05zv+9IFlSxHXEnZo+h9/RutERq4Qujj+TEpqo/QUvnWeK10RQBMN/OscT67bsHsHNrCUQvu8/AIWi0avKQNzD/Dp4MycEoOw4VobrXexzdwXncMUQb9M3yDjw9fSvCtrXd4h9Gcpw+MPL0TndYhz4MTuSY7PF2ybgT21oYnbfmFV002gT7+AtCFN7lL/brcXhLN4UUsCoW3AUN/NPW/xVSSzE86fTq6YoEjIGpikWfUUPnSbpshHwUzYY67F9MChhflQDwmk/Pg6kKmcRS98ilCuJxMIe1cysYkiJqk1QBqGuPkpq8s17zlDqsDCRk/mdBjqnAaU5RopUb3nXiBq9Xs4Jd4NzOtykJyP2h+o7xAUz5pNOOdX6doP2xk+sHs7EM7WgtchWTbyRDoDY4UMOounkX3Nv0SB6FEcIB4MIrgd1PX34Mq+Zot9/Q1Wk9fQv5+s5/omzv7o7HfpwgEj+w4ptY6XSbBMvgfjk2SnpVh4afN3R2YCw9t19FmHgMAE/LquvBRhPac4rn4mjJht5xAETAj3xQlPgvFgn"
         export AWS_REGION="us-east-1"
         aws eks update-kubeconfig --region us-east-1 --name myekscluster
         cd $folder_name
         helm install --upgrade -f values.yaml -f deployment.yaml $FOLDER_NAME/$helm_name
     
             
       
   
        
      
      
